@model Clothing_shopping.Models.Product


@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    var TargetGroup = HttpContextAccessor.HttpContext.Request.Query["TargetGroup"];
    var CategoryId = HttpContextAccessor.HttpContext.Request.Query["CategoryId"];
    var ProductId = HttpContextAccessor.HttpContext.Request.Query["ProductId"];
    var colorFromQuery = HttpContextAccessor.HttpContext.Request.Query["color"].ToString();   
    var AllGroup = ViewBag.AllGroup as Dictionary<int, string>;
    // color
    var distinctColors = Model.ProductVariants
                            .Select(s => s.Color)
                            .Distinct();
    var firsSelectedColor = distinctColors.FirstOrDefault();
    // size
    var distinctSize = Model.ProductVariants
                            .Select(s => s.Size)
                            .Distinct();
    var firsSelectedSize = distinctSize.FirstOrDefault();

    // img
    var images = JsonConvert.DeserializeObject<List<string>>(Model.Images);
    var imgList = new Dictionary<string, List<string>>();

    // Bước 1: Parse thông tin từ tên file
    var parsedImages = images.Select(img => {
        string fileName = System.IO.Path.GetFileNameWithoutExtension(img);
        string[] parts = fileName.Split('_');
        
        // Lấy màu (Phần cuối cùng)
        string color = parts.Last();

        // Lấy Variant Index (Số thứ tự biến thể - để lọc trùng)
        // Cấu trúc file: Name_VarIndex_Color_ImgIndex (hoặc Name_VarIndex_ImgIndex_Color)
        // Dựa vào code Controller trước đó: Name_VarIndex_Color_ImgIndex
        // VarIndex nằm ở vị trí thứ 3 từ dưới lên (parts.Length - 3)
        int varIndex = 0;
        if (parts.Length >= 3)
        {
            // Cố gắng parse số thứ tự biến thể
            int.TryParse(parts[parts.Length - 3], out varIndex);
        }

        return new { Path = img, Color = color, VarIndex = varIndex };
    }).ToList();

    // Bước 2: Group theo màu
    var colorGroups = parsedImages.GroupBy(x => x.Color);

    foreach (var group in colorGroups)
    {
        // Tìm Variant Index nhỏ nhất của màu này (đại diện cho bộ ảnh gốc)
        // Ví dụ: Màu đen có Variant 1, 2, 3. Ta chỉ lấy Variant 1.
        var minVarIndex = group.Where(x => x.VarIndex > 0)
                               .OrderBy(x => x.VarIndex)
                               .Select(x => x.VarIndex)
                               .FirstOrDefault();

        if (minVarIndex == 0) 
        {
            // Trường hợp ảnh đại diện hoặc ảnh không đúng định dạng variant
            imgList[group.Key] = group.Select(x => x.Path).ToList();
        }
        else
        {
            // Chỉ lấy danh sách ảnh thuộc về Variant đầu tiên của màu đó
            imgList[group.Key] = group.Where(x => x.VarIndex == minVarIndex)
                                      .Select(x => x.Path)
                                      .ToList();
        }
    }
    // --- KẾT THÚC SỬA LOGIC ẢNH ---

    // Nếu màu đầu tiên chưa có ảnh (do logic lọc có thể sai lệch với key), fallback
    if (!imgList.ContainsKey(firsSelectedColor) && imgList.Keys.Count > 0)
    {
        firsSelectedColor = imgList.Keys.FirstOrDefault();
    }

    // Lấy ảnh hiển thị mặc định
    var imgFisrt = "";
    if (imgList.ContainsKey(firsSelectedColor) && imgList[firsSelectedColor].Count > 0)
    {
        imgFisrt = imgList[firsSelectedColor].FirstOrDefault();
    }
    else if (images.Count > 0)
    {
        imgFisrt = images[0]; // Fallback ảnh gốc nếu không tìm thấy màu
    }

    var firstProduct = Model.ProductVariants.FirstOrDefault();
    var SalePrice = firstProduct.SalePrice ?? 0;
    var Price = firstProduct.Price ?? 0;
    var cultureVN = new CultureInfo("vi-VN");
}

<div class="ProductDetail">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a asp-controller="Home" asp-action="Index">Home</a>
                </li>
                <li class="breadcrumb-item">
                    @if (TargetGroup == "10"){
                        <a asp-controller="Home" asp-action="Product" asp-route-TargetGroup="0">
                            Nam
                        </a>
                        @(" và ")
                        <a asp-controller="Home" asp-action="Product" asp-route-TargetGroup="1">
                            Nữ
                        </a>
                    }
                    else
                    {
                        <a asp-controller="Home" asp-action="Product" asp-route-TargetGroup="@TargetGroup">
                            @AllGroup[int.Parse(TargetGroup)]
                        </a>
                    }
                </li>
                <li class="breadcrumb-item">
                    <a asp-controller="Home" asp-action="Product" asp-route-TargetGroup="@TargetGroup" asp-route-CategoryId="@CategoryId">
                        @ViewBag.AllCategories[int.Parse(CategoryId)]
                    </a>
                </li>
                <li class="breadcrumb-item active">
                    @Model.Name
                </li>
            </ol>
        </nav>
    </div>

    <div class="ProductDetail_container">
        <div class="ProductDetail_imgDetail">
            <div id="ImgList">
                @foreach (var img in imgList[firsSelectedColor])
                {
                    <img class="@(img == imgFisrt ? "ac" : "")" src="@img" />
                }
            </div>
            <div id="RenderImg">
                <img src="@imgFisrt" alt="" />
                <div class="RenderImg_btn">
                    <div class="RenderImg_btn_left"><i class="fa-solid fa-circle-left"></i></div>
                    <div class="RenderImg_btn_right"><i class="fa-solid fa-circle-right"></i></div>
                </div>
            </div>
        </div>

        <div class="ProductDetail_form_content">
            <form method="post" class="Form_Order">
                <div class="Color">
                    <h3>@Model.Name</h3>
                    @* @if (SalePrice == 0)
                    {
                        <input type="hidden" name="Price" type="" value="@Price" />
                    }
                    else
                    {
                        <input type="hidden" name="Price" type="" value="@SalePrice" />
                    } *@
                    <div class="from_price">
                        <div class="from_price">
                            @if (SalePrice == 0)
                            {
                                <span data-money="@Price" class="shoe_price">
                                    @Price.ToString("C0", cultureVN)
                                </span>
                            }
                            else
                            {
                                <!-- Giá sale: màu đỏ -->
                                <span data-money="@SalePrice" class="shoe_price">
                                    @SalePrice.ToString("C0", cultureVN)
                                </span>

                                <!-- Giá gốc: màu xám + gạch -->
                                <span class="shoe_salePrice">
                                    @Price.ToString("C0", cultureVN)
                                </span>
                            }
                        </div>

                    </div>
                    <h3>Màu</h3>
                    <input type="hidden" id="selectedColorInput" name="SelectedColor" value="@firsSelectedColor" />
                    <div>
                        @foreach (var pv_c in distinctColors)
                        {
                            <a data-color="@pv_c" class="btn_SelectedColor @(pv_c == firsSelectedColor ? "ac" : "")">
                                <div style="background: @pv_c"></div>
                            </a>
                        }
                    </div>
                </div>
                <div class="Size">
                    <h3>Kích cỡ</h3>
                    <input type="hidden" id="selectedSizeInput" name="SelectedSize" value="@firsSelectedSize" />
                    <div>
                        @foreach (var pv_s in distinctSize)
                        {
                            <a data-size="@pv_s" class="btn_SelectedSize @(pv_s == firsSelectedSize ? "ac" : "")">
                                <div>@pv_s</div>
                            </a>
                        }
                    </div>
                </div>
                <div class="ProductDetail_Form_btn">
                    <button type="submit">Mua</button>
                    <a href="javascript:void(0);" class="add-to-cartlist-btn">
                        Thêm vào giỏ hàng
                    </a>
                </div>
            </form>
            <div>
                @{
                    try
                    {
                        JArray jsonArray = JArray.Parse(Model.ShortDesc);

                        if (jsonArray.Count > 0)
                        {
                            <div>@jsonArray[0].ToString()</div>
                        }

                        foreach (JObject jObj in jsonArray.Skip(1).OfType<JObject>())
                        {
                            var tempDict = jObj.ToObject<Dictionary<string, List<string>>>();
                            foreach (var kvp in tempDict)
                            {
                                <ul>
                                    @foreach (var content in kvp.Value)
                                    {
                                        <li>@content.ToString()</li>
                                    }
                                </ul>
                            }
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine("Lỗi xử lý JSON: " + ex.Message);
                    }
                }
                <div><a class="ProductDetail_ChiTietSanPham">Xem chi tiết sản phẩm</a></div>
                <div>
                    <div class="ProductDetail_GiaoHangFree">
                        <span>Giao hàng và trả hàng miễn phí</span>
                        <i class="fa-solid fa-angle-down"></i>
                    </div>
                    <div class="ProductDetail_GiaoHangFree_Content">
                        <span>Đơn hàng từ 1.000.000₫ trở lên của bạn sẽ được miễn phí giao hàng tiêu chuẩn.</span>
                        <ul>
                            <li>
                                Giao hàng tiêu chuẩn trong vòng 4-5 ngày làm việc
                            </li>
                            <li>
                                Giao hàng nhanh trong vòng 2-4 ngày làm việc
                            </li>
                        </ul>
                        <span>Đơn hàng được xử lý và giao từ Thứ Hai đến Thứ Sáu (trừ ngày lễ)</span>
                        <span>Thành viên ALVÉA được hưởng <a>quyền trả hàng miễn phí</a>.</span>
                    </div>
                    <hr />
                </div>
            </div>
        </div>
    </div>

    <div class="ProductDetail_ChiTiet">
        <div class="ProductDetail_ChiTiet_Content">
            <div class="ProductDetail_ChiTiet_btn"><i class="fa-solid fa-x"></i></div>
            <div class="ProductDetail_ChiTiet_Content_ScrollArea">
                @{
                    try
                    {
                        JArray jsonArray = JArray.Parse(Model.FullDesc);

                        if (jsonArray.Count > 0)
                        {
                            <div class="ProductDetail_ChiTiet_Content_title">@jsonArray[0].ToString()</div>
                        }

                        foreach (JObject jObj in jsonArray.Skip(1).OfType<JObject>())
                        {
                            var tempDict = jObj.ToObject<Dictionary<string, List<string>>>();
                            foreach (var kvp in tempDict)
                            {
                                <div class="ProductDetail_ChiTiet_Content_key">@kvp.Key.ToString()</div>
                                <ul>
                                    @foreach (var content in kvp.Value)
                                    {
                                        <li>@content.ToString()</li>
                                    }
                                </ul>
                            }
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine("Lỗi xử lý JSON: " + ex.Message);
                    }
                }
            </div>
        </div>
    </div>
</div>

<div class="ProductReviews container mt-5">
    <h3 class="mb-4 border-bottom pb-2">Đánh giá & Nhận xét (@ViewBag.TotalReviews)</h3>
    
    <div class="d-flex align-items-center mb-4">
        <div class="display-4 fw-bold me-3">@(ViewBag.AverageRating > 0 ? ViewBag.AverageRating.ToString("0.0") : "0.0")</div>
        <div>
            <div class="text-warning fs-5">
                @for(int i=1; i<=5; i++) {
                    if(i <= ViewBag.AverageRating) { <i class="fas fa-star"></i> }
                    else if(i - 0.5 <= ViewBag.AverageRating) { <i class="fas fa-star-half-alt"></i> }
                    else { <i class="far fa-star"></i> }
                }
            </div>
            <div class="text-muted small">Dựa trên @ViewBag.TotalReviews nhận xét</div>
        </div>
    </div>

    <div class="card mb-4 shadow-sm border-0">
        <div class="card-body">
            <h5 class="card-title fw-bold">Viết nhận xét của bạn</h5>
            <form id="reviewForm">
                <input type="hidden" name="productId" value="@Model.ProductId" />
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Đánh giá sao:</label>
                    <div class="rating-input text-warning fs-4" style="cursor: pointer;">
                        <i class="far fa-star" data-value="1"></i>
                        <i class="far fa-star" data-value="2"></i>
                        <i class="far fa-star" data-value="3"></i>
                        <i class="far fa-star" data-value="4"></i>
                        <i class="far fa-star" data-value="5"></i>
                        <input type="hidden" name="rating" id="ratingValue" value="5" />
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Tiêu đề:</label>
                    <input type="text" name="title" class="form-control" placeholder="Tóm tắt nhận xét của bạn (ví dụ: Rất hài lòng)" required />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Nội dung:</label>
                    <textarea name="content" class="form-control" rows="3" placeholder="Chia sẻ cảm nhận của bạn về sản phẩm..." required></textarea>
                </div>

                <button type="button" id="btnSubmitReview" class="btn btn-dark">Gửi đánh giá</button>
            </form>
        </div>
    </div>

    <div class="review-list">
        @if (ViewBag.Reviews != null)
        {
            foreach (var review in ViewBag.Reviews as List<Clothing_shopping.Models.Review>)
            {
                <div class="d-flex mb-4 border-bottom pb-3">
                    <div class="me-3">
                        <img src="https://ui-avatars.com/api/?name=@review.User.FullName&background=random" class="rounded-circle" width="50" height="50">
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <h6 class="fw-bold mb-0">@review.User.FullName</h6>
                            <small class="text-muted">@review.CreatedAt.ToString("dd/MM/yyyy")</small>
                        </div>
                        <div class="text-warning mb-2 small">
                            @for(int i=0; i<review.Rating; i++){ <i class="fas fa-star"></i> }
                            @for(int i=review.Rating; i<5; i++){ <i class="far fa-star"></i> }
                        </div>
                        <h6 class="fw-bold text-dark">@review.Title</h6>
                        <p class="text-muted mb-0">@review.Content</p>
                    </div>
                </div>
            }
        }
    </div>
</div>

<form id="directCheckoutForm" method="post" action="@Url.Action("Checkout", "Order")" style="display:none;">
</form>

@section Scripts {
    <script>
        if (Controller == "Home" && Action == "ProductDetail") {
            // color
            const colorButtons = document.querySelectorAll(".btn_SelectedColor");
            const hiddenInputColor = document.getElementById("selectedColorInput");
            // size
            const sizeButtons = document.querySelectorAll(".btn_SelectedSize");
            const hiddenInputSize = document.getElementById("selectedSizeInput");
            // Product
            var Product = @Html.Raw(JsonConvert.SerializeObject(Model,
                new JsonSerializerSettings {               
                    ReferenceLoopHandling  = ReferenceLoopHandling.Ignore
                }
            ));
            // around fuction render tiền
            const Price = () => {
                var color;
                var size;
                colorButtons.forEach(button => {
                    if (button.classList.contains("ac")){
                        color = button.dataset.color;
                    }
                })
                sizeButtons.forEach(button => {
                    if (button.classList.contains("ac")){
                        size = button.dataset.size;
                    }
                })
                const pv = Product.ProductVariants.find(v => v.Color === color && v.Size === size);

                if (!pv) return;

                if (pv.salePrice == 0){
                    $("#display_price").text(pv.Price.toLocalString()+ "₫")
                }
                else {
                    $("#display_price").text(pv.Price.toLocalString()+ "₫")
                    $("#display_salePrice").text(pv.SalePrice.toLocalString()+ "₫")
                }
            };
            // xem chi tiết sản phẩm
            $(".ProductDetail_ChiTietSanPham").on("click", function() {
                $(".ProductDetail_ChiTiet").toggleClass("ac");
                document.body.classList.add("no-scroll");
            });
            // tắt xem chi tiết sản phẩm
            $(".ProductDetail_ChiTiet_Content").on("click", function(event) {
                event.stopPropagation();
            });

            $(".ProductDetail_ChiTiet").on("click", () => {
                 $(".ProductDetail_ChiTiet").removeClass("ac");
                 document.body.classList.remove("no-scroll");
            });

            $(".ProductDetail_ChiTiet_btn i").on("click", () => {
                 $(".ProductDetail_ChiTiet").removeClass("ac");
                 document.body.classList.remove("no-scroll");
            });
            // Giao hàng Free
            $(".ProductDetail_GiaoHangFree").on("click", () => {
                $(".ProductDetail_GiaoHangFree_Content").toggleClass("ac");
            })
            // hàm hình ảnh
            const imgList = @Html.Raw(JsonConvert.SerializeObject(imgList));
            const renderImgColor = (color) => {
                const imgs = imgList[color];
                let html ="";
                let imgFirst = imgs[0];
                imgs.forEach(img => {
                    html += `<img class="${img == imgFirst ? "ac" : ""}" src="${img}">`
                })
                $("#ImgList").html(html)
                $("#RenderImg img").attr("src", imgFirst);

                $("#ImgList img").on("click", function() {
                    $("#ImgList img").removeClass("ac");
                    $(this).addClass("ac");
                    $("#RenderImg img").attr("src", $(this).attr("src"));
                });
            }
            // đổi màu
            colorButtons.forEach(button => {
                button.addEventListener('click', () => {
                    colorButtons.forEach(btn => btn.classList.remove("ac"));
                    button.classList.add("ac");
                    hiddenInputColor.value = button.dataset.color;
                    renderImgColor(button.dataset.color);
                    Price();
                })
            })
            // đổi size
            sizeButtons.forEach(button => {
                button.addEventListener("click", () => {
                    sizeButtons.forEach(btn => btn.classList.remove("ac"));
                    button.classList.add("ac");
                    hiddenInputSize.value = button.dataset.size;
                    Price();
                    // renderImgColor(button.dataset.color);
                })
            })

            // === HIỂN THỊ ẢNH ===
            // click vào hình ảnh cập nhật hiển thị
            $("#ImgList img").on("click", function() {
                $("#ImgList img").removeClass("ac");
                $(this).addClass("ac");
                $("#RenderImg img").attr("src", $(this).attr("src"));
            });
            // btn-left ảnh
            $(".RenderImg_btn_left").on("click", () => {
                let $allThumbs = $("#ImgList img");
                let $activeThumb = $allThumbs.filter(".ac");
                let currentIndex = $allThumbs.index($activeThumb);
                let newIndex;

                if (currentIndex === 0) {
                    newIndex = $allThumbs.length - 1; // Vòng về cuối
                } else {
                    newIndex = currentIndex - 1; // Lùi 1
                }

                let $newThumb = $allThumbs.eq(newIndex);
                let newSrc = $newThumb.attr("src");

                $("#RenderImg img").attr("src", newSrc);
                $activeThumb.removeClass("ac");
                $newThumb.addClass("ac");
            });
            // btn-right ảnh
            $(".RenderImg_btn_right").on("click", () => {
                let $allThumbs = $("#ImgList img");
                let $activeThumb = $allThumbs.filter(".ac");
                let currentIndex = $allThumbs.index($activeThumb);
                let newIndex;

                if (currentIndex === $allThumbs.length-1) {
                    newIndex = 0; // Vòng về cuối
                } else {
                    newIndex = currentIndex + 1; // Lùi 1
                }

                let $newThumb = $allThumbs.eq(newIndex);
                let newSrc = $newThumb.attr("src");

                $("#RenderImg img").attr("src", newSrc);
                $activeThumb.removeClass("ac");
                $newThumb.addClass("ac");
            });
        }

        $("button[type='submit']").on("click", function(e) {
                e.preventDefault(); // Chặn submit form mặc định (vì form kia đang trống action)

                // 1. Lấy màu và size đang chọn
                const selectedColorBtn = document.querySelector(".btn_SelectedColor.ac");
                const selectedSizeBtn = document.querySelector(".btn_SelectedSize.ac");

                if (!selectedColorBtn || !selectedSizeBtn) {
                    alert("Vui lòng chọn đầy đủ Màu sắc và Kích thước!");
                    return;
                }

                const color = selectedColorBtn.dataset.color;
                const size = selectedSizeBtn.dataset.size;

                // 2. Tìm Variant ID từ dữ liệu JSON 'Product' đã có sẵn
                const variant = Product.ProductVariants.find(v => v.Color === color && v.Size === size);

                if (!variant) {
                    alert("Sản phẩm với phân loại này tạm hết hàng hoặc không tồn tại!");
                    return;
                }

                if (variant.Stock <= 0) {
                    alert("Sản phẩm này đã hết hàng!");
                    return;
                }

                // 3. Tạo Form ẩn và Submit sang Checkout
                const form = $('#directCheckoutForm');
                form.empty();
                
                // Thêm VariantId
                form.append(`<input type="hidden" name="productVariantId" value="${variant.ProductVariantId}" />`);
                
                // Thêm số lượng (Mặc định là 1 vì trang detail chưa có input số lượng, nếu có thì lấy giá trị input đó)
                // Ví dụ nếu bạn thêm input số lượng id="quantityInput", thay số 1 bằng $('#quantityInput').val()
                form.append(`<input type="hidden" name="quantity" value="1" />`); 
                
                // Submit
                form.submit();
            });

            $(".add-to-cartlist-btn").on("click", function(e) {
                e.preventDefault();

                // 1. Kiểm tra chọn Màu và Size
                const selectedColorBtn = document.querySelector(".btn_SelectedColor.ac");
                const selectedSizeBtn = document.querySelector(".btn_SelectedSize.ac");

                if (!selectedColorBtn || !selectedSizeBtn) {
                    alert("Vui lòng chọn đầy đủ Màu sắc và Kích thước!");
                    return;
                }

                const color = selectedColorBtn.dataset.color;
                const size = selectedSizeBtn.dataset.size;

                // 2. Tìm Variant ID
                const variant = Product.ProductVariants.find(v => v.Color === color && v.Size === size);

                if (!variant) {
                    alert("Sản phẩm với phân loại này tạm hết hàng hoặc không tồn tại!");
                    return;
                }

                if (variant.Stock <= 0) {
                    alert("Sản phẩm này đã hết hàng!");
                    return;
                }

                // 3. Gọi AJAX thêm vào giỏ hàng
                $.ajax({
                    url: '@Url.Action("add_cart_product", "Order")',
                    type: 'POST',
                    data: { 
                        ProductVariantId: variant.ProductVariantId, 
                        Quantity: 1 // Mặc định là 1
                    },
                    success: function(res) {
                        if (res.success) {
                            // --- THÀNH CÔNG: CHUYỂN HƯỚNG SANG GIỎ HÀNG ---
                            window.location.href = '@Url.Action("Cart", "Order")';
                        } else {
                            alert(res.message); // Ví dụ: Chưa đăng nhập
                            if(res.message.includes("đăng nhập")) {
                                window.location.href = '/User/Login';
                            }
                        }
                    },
                    error: function() {
                    alert("Lỗi kết nối server!");
                }
            });
        });

        // --- XỬ LÝ ĐÁNH GIÁ SAO ---
        const stars = document.querySelectorAll('.rating-input i');
        const ratingInput = document.getElementById('ratingValue');

        // Hàm tô màu sao
        function fillStars(value) {
            stars.forEach(star => {
                const starVal = parseInt(star.dataset.value);
                if (starVal <= value) {
                    star.classList.remove('far'); // Xóa sao rỗng
                    star.classList.add('fas');    // Thêm sao đặc
                } else {
                    star.classList.remove('fas'); // Xóa sao đặc
                    star.classList.add('far');    // Thêm sao rỗng
                }
            });
        }

        // Mặc định 5 sao
        fillStars(5);

        // Hover hiệu ứng
        stars.forEach(star => {
            star.addEventListener('mouseover', function() {
                fillStars(this.dataset.value);
            });
            star.addEventListener('mouseout', function() {
                fillStars(ratingInput.value); // Trả về giá trị đã chọn
            });
            star.addEventListener('click', function() {
                ratingInput.value = this.dataset.value;
                fillStars(this.dataset.value);
            });
        });

        // --- GỬI ĐÁNH GIÁ AJAX (FIXED VERSION) ---
        $('#btnSubmitReview').on('click', function() {
            // Lấy form
            var form = $('#reviewForm');
            
            // Validate cơ bản (nếu cần)
            if (!form[0].checkValidity()) {
                form[0].reportValidity();
                return;
            }

            // Lấy dữ liệu
            var formData = form.serialize();

            // Gửi Ajax
            $.ajax({
                url: '@Url.Action("PostReview", "Home")', // Đảm bảo đường dẫn đúng
                type: 'POST',
                data: formData,
                success: function(res) {
                    if(res.success) {
                        alert(res.message);
                        location.reload(); // Load lại trang để hiện review mới
                    } else {
                        // Xử lý lỗi (ví dụ chưa đăng nhập)
                        if(res.message && res.message.toLowerCase().includes("đăng nhập")) {
                            if(confirm(res.message + " Bạn có muốn đăng nhập ngay không?")){
                                window.location.href = '/User/Login';
                            }
                        } else {
                            alert(res.message);
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error(error);
                    alert("Lỗi kết nối server! Vui lòng thử lại.");
                }
            });
        });
    </script>
}