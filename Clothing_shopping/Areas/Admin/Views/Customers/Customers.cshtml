@model IEnumerable<Clothing_shopping.Models.User>
@{
    ViewData["Title"] = "Quản lý hồ sơ khách hàng";
}

<div class="container-fluid px-4">
    <h1 class="mt-4">Hồ sơ khách hàng</h1>
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-table me-1"></i>
            Danh sách tài khoản
        </div>
        <div class="card-body">

            <div class="row mb-3 g-3">
                <div class="col-md-4">
                    <input type="text" id="searchName" class="form-control"
                           placeholder="Nhập tên khách hàng..."
                           value="@ViewData["CurrentFilter"]">
                </div>

                <div class="col-md-3">
                    <select id="searchRole" class="form-select">
                        <option value="All">-- Tất cả chức vụ --</option>
                        <option value="Customer">Khách hàng</option>
                        <option value="Admin">Quản trị viên</option>
                        <option value="Shiper">Shipper</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <select id="searchStatus" class="form-select">
                        <option value="">-- Tất cả trạng thái --</option>
                        <option value="false">Hoạt động</option>
                        <option value="true">Đã khóa</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <button onclick="resetFilters()" class="btn btn-secondary w-100">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                </div>
            </div>

            <div id="tableData">
                @await Html.PartialAsync("_Account", Model)
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Hàm gửi Request AJAX
            function filterData() {
                // Lấy giá trị từ các ô input
                var name = $('#searchName').val();
                var role = $('#searchRole').val();   // Tương ứng tham số 'ChucVu'
                var status = $('#searchStatus').val(); // Tương ứng tham số 'isLocked'

                $.ajax({
                    url: '@Url.Action("Customers", "Customers", new { Area = "Admin" })', // Đường dẫn đến Controller
                    type: 'GET',
                    data: {
                        name: name,
                        ChucVu: role,
                        isLocked: status
                    },
                    success: function (response) {
                        // Controller trả về PartialView -> Đổ vào div #tableData
                        $('#tableData').html(response);
                    },
                    error: function (xhr, status, error) {
                        console.log("Lỗi: " + error);
                    }
                });
            }

            // Bắt sự kiện: Cứ nhập hoặc chọn là tự động lọc (Live Search)

            // 1. Khi gõ tên (dùng 'input' để bắt ngay khi gõ)
            // Dùng delay một chút để tránh spam request khi gõ nhanh (Debounce)
            var delayTimer;
            $('#searchName').on('input', function () {
                clearTimeout(delayTimer);
                delayTimer = setTimeout(function() {
                    filterData();
                }, 300); // Chờ 300ms sau khi ngừng gõ mới gửi request
            });

            // 2. Khi chọn Chức vụ
            $('#searchRole').on('change', function () {
                filterData();
            });

            // 3. Khi chọn Trạng thái
            $('#searchStatus').on('change', function () {
                filterData();
            });
        });

        // Hàm reset bộ lọc
        function resetFilters() {
            $('#searchName').val('');
            $('#searchRole').val('All');
            $('#searchStatus').val('');
            // Gọi lại sự kiện change để load lại bảng gốc
            $('#searchRole').trigger('change');
        }
    </script>
}